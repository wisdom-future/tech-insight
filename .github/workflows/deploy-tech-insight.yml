name: 🚀 Tech Insight System - Complete Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      setup_mode:
        description: 'Setup Mode'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - frontend-only
        - data-only
  schedule:
    - cron: '0 0 * * *'

env:
  NODE_VERSION: '18'

jobs:
  # 单一任务：构建和部署
  build-and-deploy:
    runs-on: ubuntu-latest
    name: 🏗️ Build and Deploy Tech Insight
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      pull-requests: write
      checks: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create Project Structure
        run: |
          echo "📁 Creating project structure..."
          
          # 创建目录结构
          mkdir -p src/{components/{common,charts,layout},views/System,router,store,utils,assets/{images,styles}}
          mkdir -p public
          mkdir -p data/{overview,collection,analysis,action,system,reports}
          
          # 生成 package.json (移除 type: module)
          cat > package.json << 'EOF'
          {
            "name": "tech-insight",
            "version": "1.0.0",
            "description": "ICT技术情报决策引擎",
            "scripts": {
              "dev": "vite",
              "build": "vite build",
              "preview": "vite preview"
            },
            "dependencies": {
              "vue": "^3.4.0",
              "vue-router": "^4.2.5",
              "pinia": "^2.1.7",
              "axios": "^1.6.0",
              "dayjs": "^1.11.10",
              "echarts": "^5.4.3",
              "vue-echarts": "^6.6.1",
              "element-plus": "^2.4.4",
              "@element-plus/icons-vue": "^2.3.1"
            },
            "devDependencies": {
              "@vitejs/plugin-vue": "^4.5.2",
              "vite": "^5.0.8",
              "tailwindcss": "^3.4.0",
              "autoprefixer": "^10.4.16",
              "postcss": "^8.4.32"
            }
          }
          EOF
          
          # 生成 vite.config.js
          cat > vite.config.js << 'EOF'
          import { defineConfig } from 'vite'
          import vue from '@vitejs/plugin-vue'
          import { resolve } from 'path'

          export default defineConfig({
            plugins: [vue()],
            base: '/tech-insight/',
            resolve: {
              alias: {
                '@': resolve(__dirname, 'src')
              }
            },
            build: {
              outDir: 'dist',
              assetsDir: 'assets'
            },
            server: {
              port: 3000,
              host: true
            }
          })
          EOF
          
          # 生成 postcss.config.js
          cat > postcss.config.js << 'EOF'
          module.exports = {
            plugins: {
              tailwindcss: {},
              autoprefixer: {},
            },
          }
          EOF
          
          # 生成 tailwind.config.js
          cat > tailwind.config.js << 'EOF'
          module.exports = {
            content: [
              "./index.html",
              "./src/**/*.{vue,js,ts,jsx,tsx}",
            ],
            theme: {
              extend: {
                colors: {
                  primary: {
                    50: '#eff6ff',
                    500: '#3b82f6',
                    600: '#2563eb',
                    700: '#1d4ed8',
                  }
                }
              }
            },
            plugins: []
          }
          EOF
          
          # 生成 index.html (修复版本)
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8" />
            <link rel="icon" type="image/svg+xml" href="./favicon.ico" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>ICT技术情报决策引擎</title>
            <meta name="description" content="基于AI的技术情报收集、分析和决策支持系统" />
          </head>
          <body>
            <div id="app">
              <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif;">
                <div style="text-align: center;">
                  <h1>ICT技术情报决策引擎</h1>
                  <p>正在加载应用程序...</p>
                  <div style="margin-top: 20px;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                  </div>
                </div>
              </div>
            </div>
            <script type="module" src="./src/main.js"></script>
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
          </body>
          </html>
          EOF

      - name: Create Vue Application Files
        run: |
          echo "🔧 Creating Vue.js application..."
          
          # 生成包含环境变量的 src/main.js
          cat > src/main.js << 'EOF'
          import { createApp } from 'vue'
          import { createPinia } from 'pinia'
          import ElementPlus from 'element-plus'
          import 'element-plus/dist/index.css'
          import * as ElementPlusIconsVue from '@element-plus/icons-vue'
          import App from './App.vue'
          import router from './router'
          import './assets/styles/main.css'

          const app = createApp(App)
          const pinia = createPinia()

          // 全局配置
          app.config.globalProperties.$config = {
            apiUrl: 'GOOGLE_APPS_SCRIPT_URL_PLACEHOLDER'
          }

          for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
          }

          app.use(pinia)
          app.use(router)
          app.use(ElementPlus)
          app.mount('#app')
          EOF
          
          # 生成包含环境变量的 src/utils/api.js
          cat > src/utils/api.js << 'EOF'
          import axios from 'axios'

          // 🔧 配置区域 - 将被环境变量替换
          const API_BASE_URL = 'GOOGLE_APPS_SCRIPT_URL_PLACEHOLDER'

          // 创建axios实例
          const api = axios.create({
            baseURL: API_BASE_URL,
            timeout: 15000,
            headers: {
              'Content-Type': 'application/json'
            }
          })

          // 请求拦截器
          api.interceptors.request.use(
            config => {
              console.log('API请求:', config.url, config.params)
              return config
            },
            error => {
              console.error('请求错误:', error)
              return Promise.reject(error)
            }
          )

          // 响应拦截器
          api.interceptors.response.use(
            response => {
              console.log('API响应:', response.data)
              return response
            },
            error => {
              console.error('响应错误:', error)
              return Promise.reject(error)
            }
          )

          // 📊 获取数据采集状态
          export const getCollectionData = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getCollectionData' }
              })
              return response.data
            } catch (error) {
              console.error('获取Collection数据失败:', error)
              throw error
            }
          }

          // 📈 获取概览数据
          export const getOverviewData = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getOverviewData' }
              })
              return response.data
            } catch (error) {
              console.error('获取Overview数据失败:', error)
              throw error
            }
          }

          // 🧠 获取分析数据
          export const getAnalysisData = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getAnalysisData' }
              })
              return response.data
            } catch (error) {
              console.error('获取Analysis数据失败:', error)
              throw error
            }
          }

          // 🎯 获取行动建议数据
          export const getActionData = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getActionData' }
              })
              return response.data
            } catch (error) {
              console.error('获取Action数据失败:', error)
              throw error
            }
          }

          // 📋 获取报告数据
          export const getReportsData = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getReportsData' }
              })
              return response.data
            } catch (error) {
              console.error('获取Reports数据失败:', error)
              throw error
            }
          }

          // 🔧 获取系统状态
          export const getSystemStatus = async () => {
            try {
              const response = await api.get('', {
                params: { action: 'getSystemStatus' }
              })
              return response.data
            } catch (error) {
              console.error('获取系统状态失败:', error)
              throw error
            }
          }

          export default api
          EOF
          
          # 生成 src/App.vue (保持原有内容)
          cat > src/App.vue << 'EOF'
          <template>
            <div id="app" class="min-h-screen bg-gray-50">
              <Header />
              <div class="flex">
                <Sidebar />
                <main class="flex-1 p-6">
                  <router-view />
                </main>
              </div>
              <Footer />
            </div>
          </template>

          <script setup>
          import Header from '@/components/layout/Header.vue'
          import Sidebar from '@/components/layout/Sidebar.vue'
          import Footer from '@/components/layout/Footer.vue'
          </script>
          EOF
          
          # 生成路由文件 (保持原有内容)
          cat > src/router/index.js << 'EOF'
          import { createRouter, createWebHistory } from 'vue-router'
          import Overview from '@/views/Overview.vue'
          import Collection from '@/views/Collection.vue'
          import Analysis from '@/views/Analysis.vue'
          import Action from '@/views/Action.vue'
          import Reports from '@/views/Reports.vue'

          const routes = [
            { path: '/', name: 'Overview', component: Overview, meta: { title: '概览总览' } },
            { path: '/collection', name: 'Collection', component: Collection, meta: { title: '数据采集' } },
            { path: '/analysis', name: 'Analysis', component: Analysis, meta: { title: '情报分析' } },
            { path: '/action', name: 'Action', component: Action, meta: { title: '行动建议' } },
            { path: '/reports', name: 'Reports', component: Reports, meta: { title: '报告中心' } }
          ]

          const router = createRouter({
            history: createWebHistory('/tech-insight/'),
            routes
          })

          export default router
          EOF
        env:
          GOOGLE_APPS_SCRIPT_URL: ${{ secrets.GOOGLE_APPS_SCRIPT_URL }}

      - name: Create Components and Views
        run: |
          echo "📦 Creating components and views..."
          
          # 创建布局组件
          cat > src/components/layout/Header.vue << 'EOF'
          <template>
            <header class="bg-white shadow-sm border-b border-gray-200">
              <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                  <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">ICT技术情报决策引擎</h1>
                  </div>
                  <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">{{ currentTime }}</span>
                  </div>
                </div>
              </div>
            </header>
          </template>

          <script setup>
          import { ref, onMounted, onUnmounted } from 'vue'

          const currentTime = ref('')

          let timer = null

          const updateTime = () => {
            const now = new Date()
            currentTime.value = now.toLocaleString('zh-CN')
          }

          onMounted(() => {
            updateTime()
            timer = setInterval(updateTime, 1000)
          })

          onUnmounted(() => {
            if (timer) {
              clearInterval(timer)
            }
          })
          </script>
          EOF
          
          cat > src/components/layout/Sidebar.vue << 'EOF'
          <template>
            <aside class="w-64 bg-white shadow-sm">
              <nav class="mt-5 px-2">
                <router-link
                  v-for="item in navigation"
                  :key="item.name"
                  :to="item.href"
                  class="group flex items-center px-2 py-2 text-base font-medium rounded-md"
                  :class="$route.name === item.name ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-50'"
                >
                  <span class="mr-3">{{ item.icon }}</span>
                  {{ item.title }}
                </router-link>
              </nav>
            </aside>
          </template>

          <script setup>
          const navigation = [
            { name: 'Overview', title: '概览总览', href: '/', icon: '📊' },
            { name: 'Collection', title: '数据采集', href: '/collection', icon: '📥' },
            { name: 'Analysis', title: '情报分析', href: '/analysis', icon: '🧠' },
            { name: 'Action', title: '行动建议', href: '/action', icon: '🎯' },
            { name: 'Reports', title: '报告中心', href: '/reports', icon: '📋' }
          ]
          </script>
          EOF
          
          cat > src/components/layout/Footer.vue << 'EOF'
          <template>
            <footer class="bg-white border-t border-gray-200">
              <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                <p class="text-center text-sm text-gray-500">
                  © 2025 ICT技术情报决策引擎. Powered by Vue.js & GitHub Pages.
                </p>
              </div>
            </footer>
          </template>
          EOF

          # 创建通用组件
          cat > src/components/common/DataCard.vue << 'EOF'
          <template>
            <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                  <span class="text-2xl mr-2">{{ data.icon || '📊' }}</span>
                  <h3 class="font-medium text-gray-900">{{ data.title || '数据卡片' }}</h3>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  {{ data.status === 'loading' ? '加载中' : '活跃' }}
                </span>
              </div>
              
              <div v-if="loading" class="space-y-2">
                <div class="animate-pulse">
                  <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                  <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                  <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                </div>
              </div>
              
              <div v-else class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">今日采集</span>
                  <span class="text-sm font-semibold text-blue-600">{{ data.todayCount || 0 }} 条</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">总计</span>
                  <span class="text-sm font-semibold">{{ data.totalCount || 0 }} 条</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">成功率</span>
                  <span class="text-sm font-semibold text-green-600">{{ data.successRate || 0 }}%</span>
                </div>
              </div>
            </div>
          </template>

          <script setup>
          const props = defineProps({
            data: {
              type: Object,
              default: () => ({})
            },
            loading: {
              type: Boolean,
              default: false
            }
          })
          </script>
          EOF

          # 创建图表组件
          cat > src/components/charts/TrendChart.vue << 'EOF'
          <template>
            <div class="w-full h-full flex items-center justify-center bg-gray-50 rounded-lg">
              <div v-if="loading" class="text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-sm">加载中...</p>
              </div>
              <div v-else class="text-gray-500 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <p class="mt-2 text-sm">趋势图表</p>
              </div>
            </div>
          </template>

          <script setup>
          const props = defineProps({
            data: {
              type: Object,
              default: () => ({})
            },
            loading: {
              type: Boolean,
              default: false
            },
            height: {
              type: String,
              default: '200px'
            }
          })
          </script>
          EOF

      - name: Create View Pages
        run: |
          echo "📄 Creating view pages..."
          
          # Overview页面
          cat > src/views/Overview.vue << 'EOF'
          <template>
            <div class="space-y-6">
              <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">系统概览</h3>
                  <div class="mt-2 max-w-xl text-sm text-gray-500">
                    <p>技术情报决策引擎运行状态总览</p>
                  </div>
                </div>
                <div class="bg-gray-50 px-5 py-3">
                  <div class="text-sm">
                    <span class="font-medium text-gray-900">状态：</span>
                    <span class="text-green-600">运行正常</span>
                  </div>
                </div>
              </div>
            </div>
          </template>
          EOF
          
          # Collection页面
          cat > src/views/Collection.vue << 'EOF'
          <template>
            <div class="space-y-6">
              <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">数据采集状态</h3>
                  <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div class="bg-blue-50 overflow-hidden shadow rounded-lg">
                      <div class="p-5">
                        <div class="flex items-center">
                          <div class="flex-shrink-0">
                            <span class="text-2xl">📚</span>
                          </div>
                          <div class="ml-5 w-0 flex-1">
                            <dl>
                              <dt class="text-sm font-medium text-gray-500 truncate">学术论文</dt>
                              <dd class="text-lg font-medium text-gray-900">1,250 条</dd>
                            </dl>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="bg-green-50 overflow-hidden shadow rounded-lg">
                      <div class="p-5">
                        <div class="flex items-center">
                          <div class="flex-shrink-0">
                            <span class="text-2xl">🔬</span>
                          </div>
                          <div class="ml-5 w-0 flex-1">
                            <dl>
                              <dt class="text-sm font-medium text-gray-500 truncate">专利数据</dt>
                              <dd class="text-lg font-medium text-gray-900">3,420 条</dd>
                            </dl>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>
          EOF
          
          # 其他页面
          cat > src/views/Analysis.vue << 'EOF'
          <template>
            <div class="space-y-6">
              <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">情报分析</h3>
                  <p class="mt-1 text-sm text-gray-600">技术情报深度分析结果</p>
                </div>
              </div>
            </div>
          </template>
          EOF
          
          cat > src/views/Action.vue << 'EOF'
          <template>
            <div class="space-y-6">
              <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">行动建议</h3>
                  <p class="mt-1 text-sm text-gray-600">基于情报分析的决策建议</p>
                </div>
              </div>
            </div>
          </template>
          EOF
          
          cat > src/views/Reports.vue << 'EOF'
          <template>
            <div class="space-y-6">
              <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                  <h3 class="text-lg leading-6 font-medium text-gray-900">报告中心</h3>
                  <p class="mt-1 text-sm text-gray-600">生成和查看各类分析报告</p>
                </div>
              </div>
            </div>
          </template>
          EOF

      - name: Create CSS and Assets
        run: |
          echo "🎨 Creating styles and assets..."
          
          cat > src/assets/styles/main.css << 'EOF'
          @tailwind base;
          @tailwind components;
          @tailwind utilities;

          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
          }
          EOF
          
          # 创建favicon
          echo "Creating favicon..."
          # 这里可以添加favicon文件，暂时跳过

      - name: Create Sample Data
        run: |
          echo "📊 Creating sample data..."
          
          cat > data/collection/tech-data-status.json << 'EOF'
          {
            "lastUpdated": "2025-06-23T10:00:00Z",
            "techData": {
              "academicPapers": {
                "title": "学术论文",
                "icon": "📚",
                "status": "active",
                "todayCount": 45,
                "totalCount": 1250,
                "successRate": 98.5,
                "trendData": [30, 35, 42, 38, 45]
              },
              "patentData": {
                "title": "专利数据", 
                "icon": "🔬",
                "status": "active",
                "todayCount": 78,
                "totalCount": 3420,
                "successRate": 96.8,
                "trendData": [65, 70, 75, 72, 78]
              }
            }
          }
          EOF

      - name: Commit Project Files to Repository
        run: |
          echo "💾 提交项目文件到仓库..."
          
          # 配置Git用户
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 添加所有文件
          git add .
          
          # 检查是否有变更
          if [ -n "$(git status --porcelain)" ]; then
            echo "📝 提交新文件..."
            git commit -m "🚀 Auto-generate project structure

            - Complete Vue.js application
            - All components and configurations  
            - Ready for development"
            
            git push
            echo "✅ 提交成功"
          else
            echo "ℹ️ 没有变更需要提交"
          fi

      - name: Replace Environment Variables
        run: |
          echo "🔧 替换环境变量..."
          
          # 替换API URL
          if [ -n "$GOOGLE_APPS_SCRIPT_URL" ]; then
            echo "设置Google Apps Script URL: $GOOGLE_APPS_SCRIPT_URL"
            sed -i "s|GOOGLE_APPS_SCRIPT_URL_PLACEHOLDER|$GOOGLE_APPS_SCRIPT_URL|g" src/utils/api.js
            sed -i "s|GOOGLE_APPS_SCRIPT_URL_PLACEHOLDER|$GOOGLE_APPS_SCRIPT_URL|g" src/main.js
            echo "✅ API URL替换完成"
          else
            echo "⚠️ 警告: GOOGLE_APPS_SCRIPT_URL 未设置，使用默认配置"
          fi
          
          echo "✅ 环境变量替换完成"
        env:
          GOOGLE_APPS_SCRIPT_URL: ${{ secrets.GOOGLE_APPS_SCRIPT_URL }}

      - name: Install Dependencies
        run: |
          echo "📦 Installing dependencies..."
          npm install

      - name: Build Application
        run: |
          echo "🔨 Building application..."
          echo "📁 构建前的文件结构:"
          find . -name "*.js" -o -name "*.vue" -o -name "*.html" | head -20
          echo "📄 package.json内容:"
          cat package.json
          echo "📄 vite.config.js内容:"
          cat vite.config.js
          echo "🔧 开始构建..."
          npm run build
          echo "📁 构建后dist目录内容:"
          ls -la dist/
          echo "📄 构建后的index.html:"
          cat dist/index.html
          echo "📁 dist/assets目录:"
          ls -la dist/assets/ || echo "assets目录不存在"
        env:
          NODE_ENV: production

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          enablement: true

      - name: Verify Build Output
        run: |
          echo "🔍 Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "❌ dist directory not found!"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "❌ index.html not found in dist!"
            exit 1
          fi
          echo "✅ Build verification passed"
          echo "📊 Dist directory size:"
          du -sh dist/
          echo "📄 Files in dist:"
          find dist/ -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Complete
        run: |
          echo "🎉 部署完成！"
          echo "🌐 访问地址: ${{ steps.deployment.outputs.page_url }}"
